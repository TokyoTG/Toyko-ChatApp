<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="../style/style.css">
    <link rel="stylesheet" href="../style/all.min.css">

    <title>TCA | Add Friends</title>
</head>

<body>
    <header>
        <div id="logo">
            <div id="lCont">
                <a href="/Public/index.html">
                    <h1 id="logoText"><span id="t">T</span><span id="c">C</span><span id="a">A</span></h1>
                </a>

            </div>
            <div id="app-name">
                <h3> Tokyo Chat App</h3>
            </div>

            <div id="contactDetails">
                <ul>
                    <li class="cont"><a href="#"><i class="fab fa-facebook"></i> <span>Facebook</span></a></li>
                    <li class="cont"><a href="#"><i class="fab fa-twitter"></i> <span>Twitter</span></a></li>
                    <li class="cont"><a href="#"><i class="fab fa-github"></i> <span>GitHub</span></a></li>
                </ul>
            </div>

        </div>
        <nav class="navbar navbar-expand-lg navbar-light ">
            <a class="navbar-brand" href="#" id="link">Add Friends</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-item nav-link active" href="#" id="link">Home <span
                            class="sr-only">(current)</span></a>
                    <a class="nav-item nav-link" href="#" id="link">Features</a>
                    <a class="nav-item nav-link" href="../index.html" id="link">Log Out</a>
                </div>
            </div>
        </nav>

    </header>
    <main class="mainT">
        <span id="menuIcon">&#9776; Menu</span>
        <section id="newSide">
            <span class="closeNav">&times;</span>
            <div class="divMenu">
                <h4>Menu</h4>
                <ul>
                    <li>
                        <a href="userPage.html"><i class="far fa-comment-alt user"></i>
                            <span>Chats</span> </a>

                    </li>
                    <li>
                        <a href="friends.html" class="friend-link"><i class="fas fa-user-friends user"></i>
                            <span>Friends</span> </a>

                    </li>
                    <li>
                        <a href="ChatRoomList.html"><i class="fas fa-users user"></i> <span>Chat Rooms</span>
                        </a>

                    </li>
                    <li>
                        <a href="FriendRequest.html"><i class="fas fa-user-clock user"></i> <span>Friend
                                Requests</span>
                        </a>

                    </li>
                    <li>
                        <a href="addFriends.html" class="active"><i class="fas fa-user-plus user"></i> <span>Add
                                Friend</span> </a>

                    </li>
                    <li>
                        <a href="editProfile.html"><i class="fas fa-user-circle user"></i> <span>Edit Profile</span>
                        </a>

                    </li>
                </ul>
            </div>

        </section>
        <section class="card new">
            <div class="friends-container">
                <ul class="list-group list-group-flush" id="friendList">

                </ul>
            </div>


        </section>
        <div class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Profile Details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="media">
                            <img src="../img/login_icon.png" class=" mr-3 profile-imgS" alt="...">
                            <div class="media-body">
                                <ul style="text-transform: capitalize;">
                                    <li id="pName">Name:</li>
                                    <li id="pLoc">Location:</li>
                                    <li id="pStatus"></li>
                                    <li id="pGender"></li>
                                    <li id="pAge">Age</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal"
                            id="closeModal">Close</button>
                        <!-- <button type="button" class="btn btn-primary" id="sendReqBtn">Send Request</button> -->
                    </div>
                </div>
            </div>
        </div>

    </main>
    <footer>
        <p>&copy; Tokyo 2020</p>

        <ul>
            <li><a href="#">FAQ</a></li>
            <li><a href="#">Policy</a></li>
            <li><a href="#">Safety</a></li>
            <li><a href="#">Contact</a></li>
        </ul>
    </footer>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/additional-methods.min.js"></script>
    <script src="../Js/index.js"></script>
    <script>
        let userDetails = JSON.parse(localStorage.getItem("userData"));
        $(document).ready(

            function popFriend() {

                //GETS ALL REGISTERED  USERS
                $.ajax({
                        method: 'GET',
                        url: 'http://localhost:3000/users',
                    })
                    .done(function (res) {
                        res.forEach(element => {
                            // FILTERS USERS WITH THOSE THE USERS HAVE SENT REQUEST 
                            $.ajax({
                                    method: 'GET',
                                    url: `http://localhost:3000/requestsSent?userId=${element.id}&senderId=${userDetails.id}`
                                })
                                .done(function (result) {
                                    if (result.length) {
                                        result.forEach(data => {
                                            $("#friendList").append(`<li
                                             class="list-group-item d-flex justify-content-between align-items-center user-${element.id}">
                                             <a href="#" class="chats" onclick="showProfile(${element.id})"
                                                 data-toggle="tooltip" data-placement="top" title="View profile details"><img
                                                     src="../img/login_icon.png" alt="..." class="profile-img">
                                                 ${element.firstname + ' '+ element.lastname}</a>
                                            <span class="sent">
                                                  sent <i class="fas fa-check"></i></span>
                                         </li>`)

                                            $('[data-toggle="tooltip"]').tooltip()

                                            $("#sendReqBtn").attr('disabled', true);

                                        })

                                        //FILTERS THE USER ITSELF
                                    } else if (userDetails.id !== element.id) {
                                        console.log(element.id)

                                        $("#friendList").append(`<li class="list-group-item d-flex justify-content-between align-items-center user-${element.id}">
     <a href="#" class="chats" onclick="showProfile(${element.id})" data-toggle="tooltip" data-placement="top"
         title="View profile details"><img src="../img/login_icon.png" alt="..." class="profile-img">
         ${element.firstname + ' '+ element.lastname}</a>
     <span class="badge" data-toggle="tooltip" data-placement="top" title="Send Request"
         onclick="sendRequest(${element.id})">
         <i class="fas fa-user-plus "></i></span> <span class="sent-${element.id}" style="display:none;"> sent <i
             class="fas fa-check"></i></span>

 </li>`)
                                        $("#sendReqBtn").attr('disabled', false);
                                        $('[data-toggle="tooltip"]').tooltip()

                                        // REMOVES USERS WHO HAVE SENT THE USER A REQUEST
                                        $.ajax({
                                                method: "GET",
                                                url: `http://localhost:3000/requestsRecieved?senderId=${element.id}&userId=${userDetails.id}`
                                            })
                                            .done(function (res) {

                                                if (res.length) {
                                                    // console.log(res)
                                                    res.forEach(d => {
                                                        console.log(d.senderId)
                                                        $(`.user-${d.senderId}`)
                                                            .remove()
                                                    })
                                                }
                                            })
                                        //REMOVES A USERS WHO IS ALREADY A FRIEND
                                        $.ajax({
                                                method: "GET",
                                                url: `http://localhost:3000/friends?friendId=${element.id}&userId=${userDetails.id}`
                                            })
                                            .done(function (ress) {
                                                if (ress.length) {
                                                    ress.forEach(d => {
                                                        $(`.user-${d.friendId}`)
                                                            .remove()
                                                    })
                                                }
                                            })
                                    }


                                })
                        });
                    })

            }
        )

        function sendRequest(id) {
            let userDetails = JSON.parse(localStorage.getItem("userData"));
            let requestData = {
                userId: id,
                senderId: userDetails.id,
                firstname: userDetails.firstname,
                lastname: userDetails.lastname,
                age: userDetails.age,
                state: userDetails.state,
                city: userDetails.city
            }


            $.ajax({
                    method: 'POST',
                    url: "http://localhost:3000/requestsRecieved",
                    data: requestData
                })
                .done(function () {
                    $.ajax({
                        method: 'POST',
                        data: requestData,
                        url: 'http://localhost:3000/requestsSent'
                    })
                })
        }

        function showProfile(id) {
            $.ajax({
                method: 'GET',
                url: 'http://localhost:3000/users/' + id,
                success: function (data) {
                    $("#pName").text(`Name: ${data.firstname}  ${data.lastname}`);
                    $("#pLoc").text(`Location: ${data.state}, ${data.city}`);
                    $("#pAge").text(`Age: ${data.age}`)
                    $("#pStatus").text(`Status: ${data.description}`)
                    $("#pGender").text(`Gender: ${data.gender}`)
                    $(".modal").modal('show')
                }
            })
        }

        $(".close").click((e) => {
            e.preventDefault();
            $(".modal").hide()
        })
        $("#closeModal").click((e) => {
            e.preventDefault();
            $(".close").click()
        })
    </script>
</body>

</html>